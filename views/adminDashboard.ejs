<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FreshMart</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.0/chart.umd.min.js" onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'"></script>
    <style>
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; background: linear-gradient(to bottom, #f9fafb 0%, #ffffff 100%); }
        .dashboard-header { background: var(--gradient-primary); color: var(--white); padding: 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3); }
        .dashboard-header h1 { margin: 0 0 10px 0; font-size: 36px; font-weight: 800; letter-spacing: -0.5px; }
        .dashboard-subtitle { font-size: 16px; opacity: 0.9; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 40px; }
        .stat-card { background: var(--white); padding: 30px; border-radius: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); border: 2px solid transparent; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%); border-radius: 50%; }
        .stat-card:hover { border-color: rgba(16, 185, 129, 0.3); transform: translateY(-5px); box-shadow: 0 8px 32px rgba(16, 185, 129, 0.15); }
        .stat-icon { width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 20px; }
        .stat-icon.revenue { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .stat-icon.orders { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .stat-icon.products { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .stat-icon.customers { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .stat-label { font-size: 14px; color: var(--dark-gray); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: 800; color: var(--text-dark); margin-bottom: 8px; letter-spacing: -1px; }
        .stat-change { font-size: 13px; font-weight: 600; }
        .stat-change.positive { color: #10b981; }
        .stat-change.negative { color: #ef4444; }
        .charts-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px; margin-bottom: 40px; }
        .chart-card { background: var(--white); padding: 30px; border-radius: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); min-height: 400px; position: relative; }
        .chart-card canvas { width: 100% !important; height: 400px !important; max-height: none !important; }
        .chart-header { margin-bottom: 24px; }
        .chart-title { font-size: 20px; font-weight: 700; color: var(--text-dark); margin-bottom: 5px; }
        .chart-subtitle { font-size: 14px; color: var(--dark-gray); }
        .recent-orders { background: var(--white); padding: 30px; border-radius: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
        .recent-orders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .recent-order-item { padding: 16px; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; transition: background 0.3s ease; }
        .recent-order-item:hover { background: rgba(16, 185, 129, 0.05); }
        .recent-order-item:last-child { border-bottom: none; }
        .order-info { flex: 1; }
        .order-id { font-weight: 700; color: var(--text-dark); margin-bottom: 4px; }
        .order-date { font-size: 13px; color: var(--dark-gray); }
        .order-amount { font-size: 18px; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 40px; }
        .action-btn { padding: 20px; background: var(--white); border: 2px solid var(--medium-gray); border-radius: 16px; text-decoration: none; display: flex; align-items: center; gap: 16px; transition: all 0.3s ease; font-weight: 600; color: var(--text-dark); }
        .action-btn:hover { border-color: var(--primary); background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%); transform: translateX(5px); }
        .action-icon { width: 48px; height: 48px; background: var(--gradient-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        @media (max-width: 992px) { .charts-section { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <%- include('partials/navbar', { user: user, currentPage: 'dashboard', pageTitle: 'Dashboard' }) %>
    
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1><i class="fas fa-chart-line"></i> Admin Dashboard</h1>
            <div class="dashboard-subtitle">Welcome back, <%= user.username %>! Here's your business overview</div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon revenue"><i class="fas fa-dollar-sign"></i></div>
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value">$<%= parseFloat(stats.totalRevenue || 0).toFixed(2) %></div>
                <div class="stat-change positive"><i class="fas fa-arrow-up"></i> From all completed orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orders"><i class="fas fa-shopping-cart"></i></div>
                <div class="stat-label">Total Orders</div>
                <div class="stat-value"><%= stats.totalOrders %></div>
                <div class="stat-change"><%= stats.completedOrders %> completed, <%= stats.pendingOrders %> pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon products"><i class="fas fa-box"></i></div>
                <div class="stat-label">Total Products</div>
                <div class="stat-value"><%= stats.totalProducts %></div>
                <div class="stat-change"><%= stats.inStockProducts %> in stock, <%= stats.outOfStockProducts %> out of stock</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon customers"><i class="fas fa-users"></i></div>
                <div class="stat-label">Total Customers</div>
                <div class="stat-value"><%= stats.totalCustomers %></div>
                <div class="stat-change">Registered users</div>
            </div>
        </div>
        
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Order Status</div>
                    <div class="chart-subtitle">Current order distribution</div>
                </div>
                <canvas id="orderStatusChart"></canvas>
                <div id="orderStatusLegend" style="display:flex; flex-wrap:wrap; gap:12px; margin-top:16px;"></div>
            </div>
        </div>
        
        <div class="recent-orders">
            <div class="recent-orders-header">
                <div>
                    <div class="chart-title">Recent Orders</div>
                    <div class="chart-subtitle">Latest customer orders</div>
                </div>
                <a href="/admin/orders" class="btn btn-secondary btn-sm">View All <i class="fas fa-arrow-right"></i></a>
            </div>
            
            <% if (recentOrders && recentOrders.length > 0) { %>
                <% recentOrders.forEach(order => { %>
                    <div class="recent-order-item">
                        <div class="order-info">
                            <div class="order-id">Order #<%= order.id %></div>
                            <div class="order-date">
                                <%= new Date(order.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %> | <%= order.username %>
                            </div>
                        </div>
                        <div class="order-amount">$<%= parseFloat(order.total).toFixed(2) %></div>
                    </div>
                <% }); %>
            <% } else { %>
                <p style="text-align: center; color: var(--dark-gray); padding: 40px;">No recent orders</p>
            <% } %>
        </div>
        
        <div class="quick-actions">
            <a href="/inventory" class="action-btn">
                <div class="action-icon"><i class="fas fa-warehouse"></i></div>
                <span>Manage Stock</span>
            </a>
            <a href="/addProduct" class="action-btn">
                <div class="action-icon"><i class="fas fa-plus-circle"></i></div>
                <span>Add New Item</span>
            </a>
            <a href="/admin/orders" class="action-btn">
                <div class="action-icon"><i class="fas fa-clipboard-list"></i></div>
                <span>View Orders</span>
            </a>
            <a href="/admin/users" class="action-btn">
                <div class="action-icon"><i class="fas fa-user-friends"></i></div>
                <span>Manage Users</span>
            </a>
        </div>
    </div>
    
    <%- include('partials/footer', { user: user }) %>
    
    <script src="/js/main.js"></script>
    <script>
        window.addEventListener('load', function() {
            const statusCanvas = document.getElementById('orderStatusChart');
            const legendContainer = document.getElementById('orderStatusLegend');
            if (!statusCanvas) return;

            const statusData = [
                <%- stats.completedOrders || 0 %>,
                <%- stats.pendingOrders || 0 %>,
                <%- stats.processingOrders || 0 %>,
                <%- stats.cancelledOrders || 0 %>
            ];

            const statusMeta = [
                { label: 'Completed', color: '#10b981' },
                { label: 'Pending', color: '#f59e0b' },
                { label: 'Processing', color: '#3b82f6' },
                { label: 'Cancelled', color: '#ef4444' }
            ];

            function renderLegend() {
                if (!legendContainer) return;
                legendContainer.innerHTML = '';
                statusMeta.forEach((item, idx) => {
                    const value = statusData[idx] || 0;
                    const row = document.createElement('div');
                    row.style.cssText = 'display:flex; align-items:center; gap:8px; font-size:13px; color:#374151; padding:6px 10px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px;';
                    const swatch = document.createElement('span');
                    swatch.style.cssText = `width:12px; height:12px; border-radius:4px; background:${item.color}; display:inline-block;`;
                    const label = document.createElement('span');
                    label.textContent = `${item.label}: ${value}`;
                    row.appendChild(swatch);
                    row.appendChild(label);
                    legendContainer.appendChild(row);
                });
            }

            function drawFallbackChart() {
                const ctx = statusCanvas.getContext('2d');
                const rect = statusCanvas.getBoundingClientRect();
                statusCanvas.width = rect.width || 600;
                statusCanvas.height = rect.height || 400;

                const total = statusData.reduce((sum, val) => sum + val, 0);
                const cx = statusCanvas.width / 2;
                const cy = statusCanvas.height / 2;
                const radius = Math.min(cx, cy) - 12;

                ctx.clearRect(0, 0, statusCanvas.width, statusCanvas.height);

                if (total <= 0) {
                    ctx.strokeStyle = '#e5e7eb';
                    ctx.lineWidth = 16;
                    ctx.beginPath();
                    ctx.arc(cx, cy, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '16px Inter, system-ui, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('No data', cx, cy);
                    renderLegend();
                    return;
                }

                let startAngle = -Math.PI / 2;
                statusData.forEach((value, idx) => {
                    if (value <= 0) return;
                    const sliceAngle = (value / total) * Math.PI * 2;
                    ctx.beginPath();
                    ctx.strokeStyle = statusMeta[idx].color;
                    ctx.lineWidth = 18;
                    ctx.arc(cx, cy, radius, startAngle, startAngle + sliceAngle);
                    ctx.stroke();
                    startAngle += sliceAngle;
                });

                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(cx, cy, radius - 22, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#1f2937';
                ctx.font = '16px Inter, system-ui, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(total + ' orders', cx, cy);
                renderLegend();
            }

            try {
                if (typeof Chart !== 'undefined') {
                    const statusCtx = statusCanvas.getContext('2d');
                    new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: statusMeta.map(item => item.label),
                            datasets: [{
                                data: statusData,
                                backgroundColor: statusMeta.map(item => item.color),
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            aspectRatio: 1.5,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { padding: 15, font: { size: 12, weight: '600' } }
                                },
                                tooltip: {
                                    backgroundColor: '#111827',
                                    padding: 12,
                                    titleFont: { size: 14, weight: 'bold' },
                                    bodyFont: { size: 13 },
                                    cornerRadius: 8
                                }
                            }
                        }
                    });
                    renderLegend();
                    return;
                }
            } catch (err) {
                console.error('Chart.js failed to render, using fallback canvas chart.', err);
            }

            drawFallbackChart();
        });
    </script>
</body>
</html>
